<?xml version="1.0" encoding="UTF-8"?>
<STEP-ProductInformation ContextID="Context1" WorkspaceID="Main" UseContextLocale="false">
    <BusinessRules>
        <BusinessRule ID="UpdateChangePackage" Scope="Global" Type="Action" RunPrivileged="false"><!-- Definition:
Action #1 (JavaScriptBusinessActionWithBinds):
<config>
  <bindings>
    <binding alias="node" type="Node" contract="CurrentObjectBindContract"/>
    <binding alias="logger" type="Logger" contract="LoggerBindContract"/>
    <binding alias="manager" type="Manager" contract="ManagerBindContract"/>
    <binding alias="eventQueue" type="EventQueue" contract="CurrentEventQueueBinding"/>
  </bindings>
  <messages/>
  <javaScript>
logger.info("AddToChangePackage user=" + node.getManager().getCurrentUser().getID() + " node=" + node)

if (node != null) {
	/** @type{ChangePackageHome} */
	var cpHome = manager.getHome(com.stibo.core.domain.changepackage.ChangePackageHome)
	var cpID = "ChangedItems-"+node.getManager().getCurrentUser().getID()
	var cp = cpHome.getChangePackageByID(cpID)

	if (cp==null) {
		cp = cpHome.createChangePackage("AutoUpdateChangePackages", cpID)
		
		cp.setName(cpID);
		cp.setSimpleValue(manager.getAttributeHome().getAttributeByID("GITBranch"), cpID)
	}

	if (!isOpen(cp)) {
		log.info("AddToChangePackage reOpen")
		cp.reOpen()
	}

	logger.info("AddToChangePackage "+eventQueue.getTitle())

	if (node instanceof com.stibo.core.domain.impl.businessrule.RevisedBusinessActionImpl) {
		// maybe remove all of RevisableNode?
		log.info("AddToChangePackage removing BR");
		cp.removeItem(node);
		return;
	}
	if (node instanceof com.stibo.core.domain.AttributeGroup ||
		node instanceof com.stibo.core.domain.setupgroup.SetupGroup) {
		logger.info("AddToChangePackage addHierarchy " + node.getClass().getName())
		cp.addHierarchy(node)
	}
	else {
		logger.info("AddToChangePackage addItem " + node.getClass().getName())
		cp.addItem(node)
	}
}

/**
 * 
 * @param {ChangePackage} pCP 
 * @returns {boolean}
 */
function isOpen(pCP) {
	var state = pCP.getValue("ChangePackageState").getSimpleValue()
	logger.info("AddToChangePackage state = " + state)
	if ("Change Package (Sealed)".equals(state)) {
		//logger.info("isOpen(" + pCP.getName() + " false")
		return false
	}
	//logger.info("isOpen(" + pCP.getName() + " true")
	return true;
}
  </javaScript>
</config> -->
            <SetupGroupLink SetupGroupID="TrackChanges"></SetupGroupLink>
            <Name QualifierID="Qualifier root">Update ChangePackage</Name>
            <OnApprove ApproveSetup="Never"></OnApprove>
            <Configuration>H4sIAAAAAAAAALVW33PTOBB+Tv4KkYdOXMC+e7uZNC1NykEYCqVJj8eOYm9SgSIZSc5cr/R/Z1eSHecKk3SAh2Ss1e737Y9PsktZLYW65mUpBdhrsbjOtVqI5fDo5N+VZGswVmg17P2Z/tFjoHJdCLUc9q5mfz//q3dy3D0aVVYosPaykpDh2iKQOy4D7E9gHXcZawwXHo6194NpcjbsveFrPs2NKF29f5o7JPoo3M1IqML2CAvRLrjhK3CYRjC0TYyQgjeb3ZYw7H1C2FRytUynzmCiveMD6QZblRx8qbQbYDnhYVNTWPvCwuPJwdINugRAHOe89GvGagvDTjnDc4dphIhxZQwo937+CXJHLuPoEblOpeA2+ipdQDQ3BY0lt81+JWV4ynbyvtXLJZgdhNI7/SrKc674bs5V8PpVpLG/L9f496GCCsgNZ/cdZmh8HkNO1Fl72kdZE/cD/b00RptzFDAW+rt1+FbnXIr/+FxCZJzBqpTcwahSBZ7lPXPenL4fJxzkkgq10P2Qx2lRzPT4Bp3gguefkZ1VFkxMmD1lJOl0CS5qo5/QIs7sytaGyVk/QecYRTHbCEm3KxasT4/syZDRiBJ21+1kh4fshcNs77ZyeK1XcM8Os25nzQ3LS1qzIYvKI0Ky9HO9Sq0Tc53m2kBa6BUXKs09UhmQ0ge4SQ06OUPIqEHvVEwcrOzzYHq6f+E1IMKFVL1nm3d0i37EiH3oUCPycjhsmtBph+YGcPRb0fWoKqevyuL/uzbsPmMBv9PxgKkF945Tj8g6aGxTgdqCf7isoN9q56lDhcwr5zsUKmtMPvlA8moyGxmu8puwTBrS+1jXE2Hfl6CQNQmloeJ2yM0ARUTAkGcw9SPuXqKNQ9vcEFTCTDiJ1dRN9+oTyjqsAPSCfV8+1KB0Hl9gBl9w6SWshYVi+6U2QbdQYpahMG/nVMlKr4FxKRmi+yg61e+Q9mTPViAAHlQ2uoz9GNQNIWSSpy/Cmw24yqgB9egR1TVTfWV0VbKvXxFpv0gUT1UuKSqd0qMHaIa8e0K8KF4LMNzkN7fswfXiL/AgPC/bJEqhHRVq9wWDtPAoaurdo1g3zSZC1CFeVV12yOj3oqSbl23fWfesHF+E7TAay+7mWkvg6r5Ld9miUl45LJ4RdPfto8sDe+/ohkMbJRPOZ/tuiiRT8ovaIMf2cU72PCo1V9MNb0iCitqcrI7oT4FLKJKwmcKXikvbD2H1GXhIHctsaGJtodGbl8UCsWBz/EPvgtWP+iegnak2yBGYbAOa54M3asvgv0uPsu2vXvwuzrY/jOM39jdBLPAxuwsAAA==</Configuration>
            <ValidObjectTypes AllObjectTypesValid="true"></ValidObjectTypes>
        </BusinessRule>
    </BusinessRules>
</STEP-ProductInformation>