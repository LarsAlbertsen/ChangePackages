<?xml version="1.0" encoding="UTF-8"?>
<STEP-ProductInformation ContextID="Context1" WorkspaceID="Main" UseContextLocale="false">
    <BusinessRules>
        <BusinessRule ID="SealChangePackage" Scope="Global" Type="Action" RunPrivileged="false"><!-- Definition:
Action #1 (JavaScriptBusinessActionWithBinds):
<config>
  <bindings>
    <binding alias="manager" type="Manager" contract="ManagerBindContract"/>
    <binding alias="node" type="Node" contract="CurrentObjectBindContract"/>
  </bindings>
  <messages/>
  <javaScript>
logger.info("SEALING "+node)

/** @type{ChangePackageHome} */
var cpHome = manager.getHome(com.stibo.core.domain.changepackage.ChangePackageHome)
var cp = cpHome.getChangePackageByID("ChangedItems")

removeDeletedItems(cp)

if (!isOpen(cp)) {
	log.info("AddToChangePackage Reopen")
	cp.reOpen()
}


cp.sealPackage("AutoSeal")

/**
* 
* @param {ChangePackage} pCP 
* @returns {boolean}
*/
function isOpen(pCP) {
	var state = pCP.getValue("ChangePackageState").getSimpleValue()
	logger.info("AddToChangePackage state = " + state)
	if ("Change Package (Sealed)".equals(state)) {
		logger.info("isOpen(" + pCP.getName() + " false")
		return false
	}
	logger.info("isOpen(" + pCP.getName() + " true")
	return true;
}

/**
 * 
 * @param {ChangePackage} pCP 
 */
function removeDeletedItems(pCP) {
	var allItems = pCP.getPrimaryItems();
	allItems.toArray().forEach(function (item) {
		if (item != null) {
			var n = pCP.getManager().getNodeFromURL(item);
			if (n == null) {
				logger.info("AddToChangePackage.removeDeletedItems item in package is deleted " + item)
				pCP.removeItem(item)
			}
		}
	})
}
  </javaScript>
</config> -->
            <SetupGroupLink SetupGroupID="TrackChanges"></SetupGroupLink>
            <Name QualifierID="Qualifier root">Seal ChangePackage</Name>
            <OnApprove ApproveSetup="Never"></OnApprove>
            <Configuration>H4sIAAAAAAAAALVW227aQBB9xl+x4SGyiWrat0pcEiBJS5ULCqR9jBZ7IJuud531GpVG/HtnL4BpSJOqqpRI3jMz58zNXnJezpm4o3nOGRR3bHaXSDFj8077+EfGyQJUwaTo1D/E7+sERCJTJuad+u3k/N3H+nE3aPfLggkoipuSQxPPBRLpbu5o/4GrGxCyAUaWjlTtDhqedupf6IKOE8Vyvbb3Eo1C35i+7zORFnXDhWwjqmgGGtNwQBUihsl5k8kyh079AWljTsU8HmuFida7h1y3dio5fCylbmE57mFbkzvbwtzj8eFctwJDYDQuaW7PhKwRgp3SiiYa03ARl1TQOShjHHibV+lxRgvvlTkvb9lUM+C0WLuIknP31HxVdFAqBUJfTx8g0a9IC5nC3+ga1Wa1+nZzE/fCPM6UkuoSB4o1/u+5XMiEcvaTTjl4xQlkOaca+qVIcbffmPN2G19OmMs5Di1mYiZDl8f4rHcxvPpE3OnI9DYKgmajQU40kjwN7jEeRjT5jol9lhmsSKMZLKgiSW6OpEP8KsRz0AYJE5nFhWZTGSdSQZzKjDIRJ5Yod0TxM9rIcyKfIzZ0O1795fDUJ+3wdKghKxyCOSvI5AJOgWNHnClMcsTZjIQHrLjOQRggIk9BDftQbUIvTSdyR4zcgMSANXktyWMFliIKVkEQ4LkAyr33mqbUcozoJiVsY9Ag+HeSm1GR3W6uSD4YWasCXSpRkKeplByoWAXY41kp7NeE+NzR2eZu+lRoXA9sFWKmT18pL2GnN15ibPx8OsZxzHCzwLlHtg2/rcOeTqy1/EofOQCjTWOrmmQdEZomQBo5YwyPJeVF6MJsCXuEfZEbEV/ZFS54GOHZG2bIBJup1FzjHBrUVvsqeiOxVuWW19MarGXGbeZIcJDkz5Mk1antWcfqBCnnFtwOcaRYRtXSuUatoLZ2ibXsKUWXYRTPpDqjyX24UQkZeriemnGYEznoEPMJdKgVE1sV/3UP7Tpc4dt+rmR2e3PhiFomwhBhxA7Lm1Ylfl4zsRnhDepffFxmkjr7dqGstFUxSToSEx1uDDhZ87+yL9+zT2EFsBdsu7l7feMF39y94f2PhV+OQ89IhAgAAA==</Configuration>
            <ValidObjectTypes AllObjectTypesValid="true"></ValidObjectTypes>
        </BusinessRule>
    </BusinessRules>
</STEP-ProductInformation>